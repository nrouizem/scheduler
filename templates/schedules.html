{% extends "base.html" %}
{% block content %}
<h1 class="mb-4 text-center">Optimal Schedules</h1>

<div class="row">
  {% for schedule_key, schedule_title in [("ortools", "Schedule 1 (Optimal)"), ("smart1", "Schedule 2 (Smart)"), ("smart2", "Schedule 3 (Smart)")] %}
    <div class="col-md-4">
      <div class="card mb-4 shadow-sm">
        <div class="card-header text-center bg-primary text-white">
          <h5 class="mb-0">{{ schedule_title }}</h5>
        </div>
        <div class="card-body p-2">
          <div class="position-relative" style="height: 840px; border: 1px solid #ccc; background-color: #fff;">
            {% for hr in range(SCHEDULE_START, SCHEDULE_END + 1) %}
              {% set top = (hr - SCHEDULE_START) * 60 %}
              <div style="position:absolute; top:{{ top }}px; left:-50px; width:45px; text-align:right; font-size:0.75rem;">{{ "%02d:00"|format(hr) }}</div>
              <div style="position:absolute; top:{{ top }}px; left:0; right:0; height:1px; background:#eee;"></div>
            {% endfor %}

            {% for item in schedules[schedule_key] %}
              {% set start_time = item.real_start if item.real_start else item.calculated_start if item.calculated_start else item.start %}
              {% set end_time = item.real_end if item.real_end else item.calculated_end if item.calculated_end else item.end %}
              {% set start_minutes = start_time.hour * 60 + start_time.minute %}
              {% set end_minutes = end_time.hour * 60 + end_time.minute %}
              {% set top = start_minutes - SCHEDULE_START * 60 %}
              {% set height = end_minutes - start_minutes %}
              <div class="position-absolute rounded text-white p-1" style="
                  top: {{ top }}px;
                  height: {{ height }}px;
                  left: 0;
                  right: 0;
                  background-color: {% if item.real_start %}#0d6efd{% else %}#6c757d{% endif %};
                  font-size: 0.8rem;
                  border: 1px solid #dee2e6;">
                <strong>{{ item.name }}</strong><br>
                {{ start_time.strftime('%I:%M %p').lstrip('0') }} - {{ end_time.strftime('%I:%M %p').lstrip('0') }}
              </div>
            {% endfor %}
          </div>

          <!-- Event List -->
          <div class="mt-3">
            <h6 class="text-center">Scheduled Items</h6>
            <ul class="list-group small">
              {% for item in schedules[schedule_key] %}
                {% set display_start = item.real_start if item.real_start else item.calculated_start if item.calculated_start else item.start %}
                {% set display_end = item.real_end if item.real_end else item.calculated_end if item.calculated_end else item.end %}
                <li class="list-group-item">
                  <strong>{{ item.name }}</strong><br>
                  {{ display_start.strftime('%I:%M %p') }} – {{ display_end.strftime('%I:%M %p') }}<br>
                  Category: {{ item.category }}<br>
                  Priority: {{ item.priority if item.priority is defined else "—" }}
                </li>
              {% endfor %}
            </ul>
          </div>

          <!-- Commit Button -->
          <form method="post" action="{{ url_for('commit_schedule', which=schedule_key) }}">
            <button class="btn btn-success w-100 mt-3">Use This Schedule</button>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Unscheduled Tasks -->
{% if schedules.unscheduled %}
  <div class="mt-5">
    <h3 class="text-danger text-center">Unscheduled Tasks</h3>
    <ul class="list-group">
      {% for task in schedules.unscheduled %}
        <li class="list-group-item">
          <strong>{{ task.name }}</strong><br>
          Duration: {{ task.estimated_duration }} min<br>
          Priority: {{ task.priority }}<br>
          Flexibility: {{ task.flexibility }}
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<!-- Back Button -->
<div class="text-center mt-5">
  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>
{% endblock %}
